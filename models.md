# Модели OCR/HTR, используемые в проекте

Здесь собраны модели рукописного OCR/HTR, с которыми мы работаем в
репозитории `handwritten-ocr`, и кратко описано, какую роль каждая из них
играет в экспериментах.

В коде (`src/models/ocr_models`) реализованы лёгкие взаимозаменяемые обёртки
над несколькими TrOCR‑моделями;

Минимальный интерфейс в этом репозитории:

```python
from models import get_ocr_model

model = get_ocr_model("trocr_kazars")  # или trocr_raxtemur / trocr_cyrillic
text = model.predict("path/to/image.jpg")  # -> str
```

Мини‑набор для быстрых тестов: `data/mini-test/*.JPG` (+ соответствующие `.txt`).

---

## 1. Основные HTR‑модели в коде (`src/models/ocr_models`)

Эти модели интегрированы в код через `AVAILABLE_OCR_MODELS` и используются
в скриптах `src/infer_page.py` и `src/eval_folder.py`.

### 1.1 Сводная таблица TrOCR‑моделей

| Короткое имя | Hugging Face ID | Архитектура | Параметры | Данные / домен | CER (из источников) |
|-------------|-----------------|-------------|-----------|----------------|----------------------|
| `trocr_kazars` | `kazars24/trocr-base-handwritten-ru` | TrOCR‑base (ViT encoder + Transformer decoder) | ≈334M | Современная рукописная кириллица (Cyrillic Handwriting Dataset, ~73k сегментов) | ≈4.85% (валид. CER) |
| `trocr_raxtemur` | `raxtemur/trocr-base-ru` | TrOCR‑base | ≈334M | Синтетические русские/кириллические данные (StackMix HKR/CYR + synthetic) | ~6.8–9.3% на HKR/CYR |
| `trocr_cyrillic` | `cyrillic-trocr/trocr-handwritten-cyrillic` | TrOCR‑base (fine‑tune от `kazars24`) | ≈334M | Историческая рукописная кириллица (Church Slavonic / старый русский / украинский) | CER (val, HF): 0.253 |

Все три модели — это TrOCR (VisionEncoderDecoderModel). В обёртках
`src/models/ocr_models/trocr.py` к ним добавлен шаг детекции строк на целой
странице через `PaddleOCR`, поэтому можно подавать как отдельные строки, так
и целые страницы.

### 1.2 Общий интерфейс и препроцессинг

- **Вход**:
  - путь к изображению (`str`) или `PIL.Image.Image`;
  - изображение внутри переводится в `RGB`.
- **Детекция строк/областей**:
  - в `_BaseTrOCRModel.load()` инициализируется `PaddleOCR(lang="ru", ...)`;
  - `_crop_lines()` вызывает `detector.predict(...)`, берёт полигоны `dt_polys`,
    сортирует их сверху‑вниз и слева‑направо, расширяет каждый полигон небольшим
    паддингом и режет страницу на кропы;
  - если детектор ничего не нашёл, модель работает по всей странице как по
    одной "строке".
- **Распознавание**:
  - для каждого кропа вызывается TrOCR‑модель через `TrOCRProcessor` и
    `VisionEncoderDecoderModel.generate(...)`;
  - все непустые строки собираются в многострочный текст (`"\n".join(...)`).

Таким образом, нарезка страницы на "слайсы" (строки/области текста) реализована
кастомной логикой поверх полигона `dt_polys` из PaddleOCR, а не простым
фиксированным гридом.

### 1.3 Индивидуальные комментарии по моделям

**`trocr_kazars`** (`kazars24/trocr-base-handwritten-ru`)
- Лучший вариант для **современной рукописной кириллицы** среди протестированных.
- Даёт внятные русские слова на уровне строк; на целых страницах качество
  сильно зависит от детекции строк.

**`trocr_raxtemur`** (`raxtemur/trocr-base-ru`)
- Тоже TrOCR‑base, но обучен на больших синтетических наборах HKR/CYR.
- На реальных рукописях (HWR200) выдаёт много осмысленных слов, но часто
  с большим количеством ошибок и слитных фрагментов; полезен как альтернативный
  baseline / ensemble.

**`trocr_cyrillic`** (`cyrillic-trocr/trocr-handwritten-cyrillic`)
- Специализирован под **историческую/церковнославянскую кириллицу**.
- На современном школьном тексте (HWR200) даёт характерный "старославянский"
  вывод; полезен скорее как демонстрация исторического HTR, чем как рабочая
  модель для текущего кейса.

---

## 2. Классические OCR‑библиотеки (общий, а не рукописный OCR)

Эти библиотеки ориентированы в первую очередь на печатный текст.
Для рукописного русского текста (особенно курсивного HWR200) они показывают
низкое качество. В проекте они используются только как внешние baseline‑ы
“для справки”, а не как рабочие решения.

### 2.1 Краткие комментарии

- **PaddleOCR (PP‑OCRv4)**  
  - основная цель — печатный текст, формуляры, документы, сцены;  
  - существуют отдельные эксперименты с рукописью, но нет специализированной
    модели под русскую рукопись;  
  - на наших страницах HWR200 качество среднее, зато детектор строк работает
    достаточно стабильно; в проекте мы фактически используем именно детектор
    (PaddleOCR как “поисковик слайсов” для TrOCR).

- **EasyOCR**  
  - поддерживает много языков и частично рукописный текст, но без фокуса на
    русскую рукопись;  
  - на HWR200 выдаёт много шума, пригоден только как очень грубый baseline.

- **Tesseract 5.x**  
  - классический LSTM‑OCR для печатных документов;  
  - для рукописной кириллицы практически неприменим (на HWR200 результат
    близок к пустому).

В основной код (`src/models/ocr_models`) эти библиотеки не интегрированы.
Полезный для нас компонент PaddleOCR — детектор прямоугольных/многоугольных
областей текста, на основе которого реализована нарезка страниц на строки
в обёртках TrOCR.

---

## 3. Модели, которые мы исключили из основного пайплайна

Ряд моделей формально реализован в коде, но **отключён** из фабрики
`get_ocr_model` и не включён в `AVAILABLE_OCR_MODELS`, так как по результатам
тестов качество на нашем целевом датасете оказалось неудовлетворительным или
интеграция слишком тяжёлая.

### 3.1 `trocr_kansallis` (`Kansallisarkisto/cyrillic-htr-model`)

- TrOCR‑large (≈558M параметров) для исторических документов.
- Требует много памяти, имеет нестандартную структуру репозитория, из‑за чего автоматическая загрузка через
  `transformers` нестабильна.

### 3.2 `peter_crnn` и `reading_pipeline_peter`

- **`peter_crnn`** — CRNN на весах из `ReadingPipeline-Peter`.
- **`reading_pipeline_peter`** — полный пайплайн сегментация+OCR из
  `ai-forever/ReadingPipeline`.
- На современных школьных страницах HWR200 они показали **очень низкое
  качество**, заметно хуже TrOCR‑моделей.
- В этом репозитории обёртки оставлены только для экспериментов и явно
  помечены как отключённые:
  - не входят в `AVAILABLE_OCR_MODELS`;
  - не регистрируются в `get_model`.

---

## 4. Другие модели рукописного OCR на кириллице (краткий обзор)

Помимо TrOCR‑моделей, в литературе и открытых репозиториях есть ряд нейросетей,
реально обученных и протестированных на рукописных текстах на кириллице
(русский / казахский / исторический русский). Ниже — самые релевантные.

- **Attention‑Based Fully Gated CNN‑BGRU (HKR)**  
  - статья *“Attention‑Based Fully Gated CNN‑BGRU for Russian Handwritten Text”* (2020) обучена на датасете HKR — рукописные слова на **русском и казахском** в кириллице (≈95% русских слов);  
  - достигает **CER ≈4–6%** и **WER ≈19–24%** на разных сплитах HKR;  
  - код и датасет доступны, но интеграция требует собственного тренинга, поэтому
    модель у нас не реализована.

- **SimpleHTR / Bluche / Puigcerver на HKR**  
  - в работе по классификации рукописных названий городов и стран на кириллице
    (HKR) тестировались классические модели **SimpleHTR (CNN‑RNN‑CTC)**,
    **Bluche**, **Puigcerver** и др.;  
  - показано, что они способны распознавать русско‑казахский рукописный текст,
    но нуждаются в дообучении под конкретный датасет;  
  - в этом репозитории мы ограничились готовыми TrOCR‑чекпойнтами вместо
    реализации собственного train‑pipeline для этих архитектур.

- **StackMix HTR (ResNet+BiGRU+CTC, HKR и Digital Peter)**  
  - серия работ *“StackMix and Blot Augmentations for Handwritten Text Recognition”* и репозиторий **StackMix‑OCR** + **hrtr** (\"Handwritten Russian text recognition\");  
  - обучены на **HKR**, **Cyrillic Handwriting Dataset**, **Digital Peter** и др.,
    показывают **CER ≈3.5% / WER ≈13%** на HKR;  
  - это сильный CNN+BiGRU+CTC‑baseline для русской рукописи, но в проекте мы
    остановились на более простом для интеграции варианте — TrOCR‑чекпойнты с
    детекцией строк.

- **SVTR на KOHTD (Kazakh Offline Handwritten Text Dataset)**  
  - в работе *“SVTR model for Kazakh Handwritten Text Recognition”* модель
    **SVTR** (из PaddleOCR) адаптирована под датасет **KOHTD** — рукописные
    экзаменационные работы на казахском языке в кириллице;  
  - достигнуты **CER ≈4.59%** и **WER ≈20%**;  
  - архитектура и код доступны, но это отдельный стек (PaddlePaddle) и своя
    обученная модель, поэтому в текущий репозиторий мы её не включали.

- **Модели для исторических документов (Digital Peter и др.)**  
  - в датасете **Digital Peter** (исторические рукописи Петра I, кириллица)
    тестировались CRNN/ResNet+BLSTM и другие HTR‑архитектуры; лучшие результаты
    опускаются до **CER ~2.5% / WER ~14.6%** на строках;  
  - есть и более новые подходы (StackMix HTR, языковые модели поверх HTR и т.п.),
    но готовых “одним импортом” моделей для современного русского текста из этих
    работ нет, поэтому мы используем их как ориентир по качеству, а не как
    прямой baseline в коде.
