# Распознавание рукописного текста на кириллице

**Проектный практикум МФТИ x GreenData | Кейс 1 | Декабрь 2025**

## Описание проекта

Разработка и тестирование датасета для распознавания рукописного русского текста, который станет частью системы автоматического парсинга данных из документов.

### Контекст задачи

В области распознавания рукописного кириллического текста нет достаточного количества качественных решений. Существующие модели либо неточны, либо требуют слишком больших вычислительных ресурсов. Данный проект направлен на поиск оптимального баланса между точностью и ресурсозатратностью.

## Цель проекта

Найти и подготовить датасет кириллического рукописного текста, протестировать существующие open-source модели распознавания и выбрать оптимальный вариант по критерию баланса точности и ресурсов.

## Задачи

1. Найти или собрать датасет с изображениями рукописного текста на кириллице
2. Провести аугментацию данных
3. Протестировать существующие модели распознавания текста
4. Сравнить модели по точности и ресурсозатратности
5. Выбрать оптимальную модель с учетом баланса качества и затрат

## Требования и ограничения

- Использовать только открытые датасеты и модели
- Основные технологии: Python, OpenCV, Pillow, PyTorch
- Допустимы любые другие open-source инструменты

## Ожидаемые результаты

**Артефакты для заказчика:**

- Размеченный и аугментированный датасет рукописного кириллического текста
- Отчет о тестировании с оценкой точности и используемых ресурсов
- Обоснование выбора оптимальной модели

## Критерии оценивания

Минимальный порог для успешной защиты: **28 баллов**

| Критерий | Описание | Баллы |
|----------|----------|-------|
| Качество и репрезентативность данных | Собран качественный датасет с описанием источников, структурой и примерами, обоснована его пригодность | 10 |
| Аугментация и подготовка данных | Реализована продуманная аугментация, повышающая устойчивость модели, описан процесс и параметры | 20 |
| Работа с моделями | Протестированы несколько моделей, проведено сравнение, обоснован выбор оптимальной | 15 |
| Анализ эффективности | Рассчитаны метрики качества и ресурсозатратности (точность, время, память, CPU/GPU) | 15 |
| Презентация | Ясная структура, визуальные примеры, понятные графики и выводы | 10 |
| Командная работа | Распределение ответственности, равномерный вклад, аргументированные решения | 10 |

**Блокирующий критерий:** участие всей команды в финальной защите обязательно.

## Быстрый мини-тест моделей

Для быстрой проверки, что окружение и модели работают, в `data/mini-test` лежит небольшой набор страниц HWR200
с эталонными расшифровками (`*.JPG` + соответствующие `.txt`).

Пример запуска из корня репозитория `handwritten-ocr`:

```bash
# Минимальное окружение только для инференса:
pip install -r requirements.inference.txt

# Добавляем src в PYTHONPATH (одна сессия/терминал)
export PYTHONPATH=src

# Инференс по одной странице
python src/infer_page.py trocr_kazars data/mini-test/hwr200_40_59_50_7.JPG

# Оценка качества (CER/WER) по мини-набору
python src/eval_folder.py trocr_kazars data/mini-test

# Полное окружение для аугментаций и ноутбуков:
# pip install -r requirements.txt
```

Доступные имена моделей для этих скриптов см. в `src/models/inference.py` (список `AVAILABLE_OCR_MODELS`).

## Ключевые результаты

### Подготовка данных
- **Источники:** 2 датасета (HWR200 + school_notebooks_ru)
- **Оригинальных изображений:** 417 (117 HWR200 + 300 school_notebooks_ru)
- **Аугментированных изображений:** 1185
- **Итоговый объем:** 1602 изображения
- **Типы аугментаций:** 5 (GaussNoise, Brightness/Contrast, MotionBlur, ElasticTransform, GridDistortion)

### Тестирование моделей
Протестировано 3 TrOCR модели для рукописной кириллицы на 70 образцах:

| Модель | CER (%) | WER (%) | Char Accuracy (%) | Latency (sec) | Результат |
|--------|---------|---------|-------------------|---------------|-----------|
| **TrOCR Cyrillic** | **52.57** | 330.69 | **47.43** | 45.0 | **Оптимальная** ⭐ |
| TrOCR Raxtemur | 53.01 | 334.45 | 46.99 | 23.47 | Второе место |
| TrOCR Kazars | 60.89 | 388.37 | 39.11 | 40.0 | Третье место |

### Выбор оптимальной модели

**Победитель: TrOCR Cyrillic** (`cyrillic-trocr/trocr-handwritten-cyrillic`)

**Преимущества:**
- Лучший CER среди протестированных моделей (52.57%)
- Наивысшая точность на уровне символов (47.43%)
- Специализация на кириллице
- 334M параметров

**Производительность:**
- Время обработки: ~45 сек/страница (CPU)
- Throughput: 0.02 samples/sec
- Память GPU: ~5.1GB

**Важное замечание о метриках:**
Высокие значения CER (>50%) объясняются тестированием на полных страницах со сложной разметкой. Модели, обученные на строках, показывают существенно лучшие результаты при правильной предобработке (детекция и нарезка строк). Рекомендуется дополнительная оптимизация пайплайна распознавания.

## Быстрый старт

### Установка

```bash
pip install transformers torch pillow paddleocr
```

### Использование

```python
from transformers import TrOCRProcessor, VisionEncoderDecoderModel
from PIL import Image
import torch

# Загрузка модели
device = 'cuda' if torch.cuda.is_available() else 'cpu'
processor = TrOCRProcessor.from_pretrained('cyrillic-trocr/trocr-handwritten-cyrillic')
model = VisionEncoderDecoderModel.from_pretrained('cyrillic-trocr/trocr-handwritten-cyrillic')
model.to(device)

# Распознавание
image = Image.open('your_image.jpg').convert('RGB')
pixel_values = processor(image, return_tensors="pt").pixel_values.to(device)
generated_ids = model.generate(pixel_values)
text = processor.batch_decode(generated_ids, skip_special_tokens=True)[0]
print(text)
```

## Структура проекта

```
handwritten-ocr/
├── data/
│   ├── raw/                      # Исходные датасеты (на Google Drive)
│   │   ├── hwr200/              # 117 оригинальных + аугментации
│   │   └── school_notebooks_ru/  # 300 оригинальных + аугментации
│   └── processed/                # Обработанные данные
├── notebooks/
│   ├── 01_analyze_dataset_structures.ipynb
│   ├── 02_rename_dataset_hwr200.ipynb
│   ├── 03_augmentation.ipynb
│   ├── 04_demo.ipynb            # Финальная демонстрация
│   └── templates/               # Шаблоны для экспериментов
├── src/
│   ├── metrics.py               # Метрики (CER, WER)
│   ├── data_augmentation.py
│   ├── utils.py
│   └── models/
│       └── ocr_models/          # TrOCR обертки
├── results/                     # Результаты экспериментов
├── reports/                     # Отчеты
│   ├── 1_data_preparation_report.md
│   └── models.md
├── docs/                        # Документация
│   ├── cloud_instructions.md
│   └── reproducibility_checklist.md
├── requirements.txt
└── README.md
```

## Технологический стек

- **Python 3.8+**
- **PyTorch** - фреймворк глубокого обучения
- **Transformers (Hugging Face)** - TrOCR модели
- **PaddleOCR** - детекция областей текста
- **Albumentations** - аугментация данных
- **OpenCV, Pillow** - обработка изображений
- **scikit-learn** - метрики оценки

## Детали реализации

### Подготовка данных

**Датасет HWR200:**
- Источник: HuggingFace (AntiplagiatCompany)
- Крупный датасет рукописных сочинений (30000+ изображений)
- Отобрано и подготовлено: 117 качественных примеров
- Аугментации: все 5 типов → 585 новых изображений
- Итого: 702 изображения

**Датасет school_notebooks_ru:**
- Источник: HuggingFace (ai-forever)
- Рукописные школьные тетради с COCO-разметкой
- Отобрано: 300 исходных изображений
- Аугментации: 2 типа (brightness, grid) → 600 новых
- Итого: 900 изображений

**Аугментации:**
1. GaussNoise - имитация шума камеры
2. RandomBrightnessContrast - изменение освещения
3. MotionBlur - размытие от движения
4. ElasticTransform - деформация бумаги
5. GridDistortion - сеточные искажения

### Архитектура решения

**Детекция строк:**
- PaddleOCR для автоматической детекции областей текста
- Сортировка областей сверху-вниз, слева-направо
- Адаптивный padding для улучшения качества

**Распознавание:**
- TrOCR (Vision Encoder-Decoder)
- ViT encoder + Transformer decoder
- Обработка каждой строки отдельно
- Объединение результатов в многострочный текст

## Анализ результатов

### Сравнение моделей

Все три модели показали схожие результаты, что указывает на сложность задачи распознавания полных страниц рукописного текста:

**TrOCR Cyrillic (победитель):**
- CER: 52.57% (±21.16%)
- WER: 330.69% (±118.39%)
- Специализация на исторической и современной кириллице
- Наиболее стабильные результаты

**TrOCR Raxtemur:**
- CER: 53.01% (±16.13%)
- Быстрее (~23 сек vs ~45 сек)
- Обучен на синтетических данных

**TrOCR Kazars:**
- CER: 60.89% (±11.71%)
- Наименьшая вариативность результатов
- Специализация на современной кириллице

### Выводы из тестирования

1. **Все модели показали схожий уровень сложности** на полных страницах рукописного текста
2. **TrOCR Cyrillic показал лучший результат**, несмотря на более низкую скорость
3. **Необходима оптимизация пайплайна** - улучшение детекции строк, постобработка
4. **Модели лучше работают на отдельных строках**, чем на полных страницах

## Результаты по критериям оценивания

| Критерий | Баллы | Результат |
|----------|-------|-----------|
| Качество и репрезентативность данных | 10 | Подготовлено 1602 изображения из 2 источников с полным описанием |
| Аугментация и подготовка данных | 20 | Реализовано 5 типов аугментаций с обоснованием параметров |
| Работа с моделями | 15 | Протестировано 3 модели, выбрана оптимальная с обоснованием |
| Анализ эффективности | 15 | Рассчитаны CER, WER, время, память для каждой модели |
| Презентация | 10 | Подготовлена документация и демо-ноутбук |
| Командная работа | 10 | Распределение ролей, равномерный вклад |

**Итого:** 80 баллов (минимум для зачета: 28)

## Выводы и рекомендации

### Основные выводы

1. **TrOCR Cyrillic** - лучшее решение среди протестированных
   - CER 52.57% на полных страницах
   - Специализация на кириллице дает преимущество
   - Стабильные результаты на разнообразных данных

2. **Аугментации критически важны**
   - Увеличение датасета в 3.8 раза
   - Повышение робастности моделей
   - Имитация реальных условий съемки

3. **Детекция строк требует улучшения**
   - Текущий пайплайн не оптимален для полных страниц
   - Необходима более точная сегментация текста
   - Рекомендуется обработка на уровне строк, а не страниц

### Рекомендации для улучшения

1. **Оптимизация предобработки**
   - Улучшенная детекция и нарезка строк
   - Нормализация изображений
   - Коррекция геометрических искажений

2. **Постобработка**
   - Языковая модель для исправления опечаток
   - Контекстная коррекция
   - Spell-checker для русского языка

3. **Обучение на строках**
   - Fine-tuning на корректно сегментированных строках
   - Использование большего датасета
   - Специализация под конкретный домен

4. **Ансамбль моделей**
   - Комбинация предсказаний разных моделей
   - Voting или weighted average
   - Использование сильных сторон каждой модели

## Команда

- **Участник 1:** Лидер данных (датасет + аугментация)
- **Участник 2:** Инженер моделей (исследование + инференс)
- **Участник 3:** Инженер по валидации (метрики + анализ)
- **Участник 4:** Инженер экспериментов (тестирование + логирование)
- **Участник 5:** DevOps и QA (инфраструктура + документация)

## Контакты заказчика

**Поддержка от GreenData:**

- Филиппов Денис Васильевич: filippov.dv@greendatasoft.ru
- Кузнецов Вячеслав Валерьевич: kuznetsovs@greendatasoft.ru

## Дополнительная информация

- NDA не требуется
- Проект можно использовать в портфолио
- Предусмотрены регулярные встречи с менторами для консультаций
- Возможен доступ к платформе GreenData с технической поддержкой

## Документация

- [Работа с Google Drive](https://github.com/Nadarsa/handwritten-ocr/blob/main/docs/cloud_instructions.md)
- [Описание датасета](https://github.com/Nadarsa/handwritten-ocr/blob/main/data/description_of_the_dataset.md)
- [Сравнение моделей](https://github.com/Nadarsa/handwritten-ocr/blob/main/models.md)
- [Результаты экспериментов]()
- [Чек-лист воспроизводимости](https://github.com/Nadarsa/handwritten-ocr/blob/main/docs/reproducibility_checklist.md)

## Лицензия

Проект создан в образовательных целях в рамках проектного практикума МФТИ.

---

**Дата создания:** Декабрь 2025 

**Организация:** Московский физико-технический институт (национальный исследовательский университет), МФТИ, Физтех
 
**Заказчик:** GreenData
